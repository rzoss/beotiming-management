<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>BEO-Timing: neueruserdialog.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>neueruserdialog.cpp</h1><a href="neueruserdialog_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00031"></a>00031 <span class="preprocessor">#include "<a class="code" href="neueruserdialog_8h.html" title="Dieser Dialog dient zum erstellen eines neuen Benutzers.">neueruserdialog.h</a>"</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;QtSql&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;QtGui&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include "<a class="code" href="_user_8h.html" title="Diese Klasse symbolisiert einen Benutzer und stellt Funktionen bereit.">User.h</a>"</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include "<a class="code" href="md5_8h.html" title="Diese Funktionen liefern die Moeglichkeit, einen MD5-Hash eines beliebigen String...">md5/md5.h</a>"</span>
<a name="l00036"></a>00036 
<a name="l00042"></a><a class="code" href="class_neuer_user_dialog.html#6042fa6723528bcfb392d186079eda52">00042</a> <a class="code" href="class_neuer_user_dialog.html#6042fa6723528bcfb392d186079eda52" title="Konstruktor.">NeuerUserDialog::NeuerUserDialog</a>(<a class="code" href="class_user.html" title="Diese Klasse symbolisiert einen Benutzer und stellt Funktionen bereit.">User</a>* user, QWidget *parent)
<a name="l00043"></a>00043     : QDialog(parent)
<a name="l00044"></a>00044 {
<a name="l00045"></a>00045         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#a5315d1a0ab462b8545f222ea764c6d6">setupUi</a>(<span class="keyword">this</span>);
<a name="l00046"></a>00046         this-&gt;<a class="code" href="class_neuer_user_dialog.html#4f0a500dbb82eb6f8c7ca521aab8f332">pUser</a>=user;
<a name="l00047"></a>00047         
<a name="l00048"></a>00048         <span class="comment">// Validators</span>
<a name="l00049"></a>00049         <span class="comment">// Nur Buchstaben und Leerschläge</span>
<a name="l00050"></a>00050         QRegExp charExp (<span class="stringliteral">"[\\-\\w\\s]+"</span>);
<a name="l00051"></a>00051         <span class="comment">// Nur 5 kleine Buchstaben und 1 Zahl</span>
<a name="l00052"></a>00052         QRegExp userExp (<span class="stringliteral">"[a-z][a-z][a-z][a-z][a-z][0-9]"</span>);
<a name="l00053"></a>00053         <span class="comment">// E-mail address is validated according to RFC2821, RFC2822,</span>
<a name="l00054"></a>00054         <span class="comment">// see http://en.wikipedia.org/wiki/E-mail_address.</span>
<a name="l00055"></a>00055         <span class="comment">// http://www.virtualbox.org/changeset/7487?format=diff&amp;new=7487</span>
<a name="l00056"></a>00056         QRegExp emailExp (<span class="stringliteral">"(([a-zA-Z0-9_\\-\\.!#$%\\*/?|^{}`~&amp;'\\+=]*"</span>
<a name="l00057"></a>00057                                     <span class="stringliteral">"[a-zA-Z0-9_\\-!#$%\\*/?|^{}`~&amp;'\\+=])|"</span>
<a name="l00058"></a>00058                                   <span class="stringliteral">"(\"([\\x0001-\\x0008,\\x000B,\\x000C,\\x000E-\\x0019,\\x007F,"</span>
<a name="l00059"></a>00059                                        <span class="stringliteral">"\\x0021,\\x0023-\\x005B,\\x005D-\\x007E,"</span>
<a name="l00060"></a>00060                                        <span class="stringliteral">"\\x0009,\\x0020]|"</span>
<a name="l00061"></a>00061                                      <span class="stringliteral">"(\\\\[\\x0001-\\x0009,\\x000B,\\x000C,"</span>
<a name="l00062"></a>00062                                             <span class="stringliteral">"\\x000E-\\x007F]))*\"))"</span>
<a name="l00063"></a>00063                                     <span class="stringliteral">"@"</span>
<a name="l00064"></a>00064                                     <span class="stringliteral">"[a-zA-Z0-9\\-]+(\\.[a-zA-Z0-9\\-]+)*"</span>);
<a name="l00065"></a>00065         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#ee98382add2320120c64b7c1ac79e4dc">usernameLineEdit</a>-&gt;setValidator(<span class="keyword">new</span> QRegExpValidator (userExp, <span class="keyword">this</span>));
<a name="l00066"></a>00066         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#ee98382add2320120c64b7c1ac79e4dc">usernameLineEdit</a>-&gt;setMaxLength(6);
<a name="l00067"></a>00067         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#5d7ac7d442a96686d9fa74ea43e9fe83">nameLineEdit</a>-&gt;setValidator (<span class="keyword">new</span> QRegExpValidator (charExp, <span class="keyword">this</span>));
<a name="l00068"></a>00068         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#5d7ac7d442a96686d9fa74ea43e9fe83">nameLineEdit</a>-&gt;setMaxLength (50);
<a name="l00069"></a>00069         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#05a279f8550cee40c692ae767f1331db">emailLineEdit</a>-&gt;setValidator (<span class="keyword">new</span> QRegExpValidator (emailExp, <span class="keyword">this</span>));
<a name="l00070"></a>00070         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#05a279f8550cee40c692ae767f1331db">emailLineEdit</a>-&gt;setMaxLength (50);
<a name="l00071"></a>00071                 
<a name="l00072"></a>00072         <span class="comment">// Usertypen ComboBox erstellen</span>
<a name="l00073"></a>00073         QStringList list;
<a name="l00074"></a>00074         QString sql=<span class="stringliteral">"SELECT name FROM usertype WHERE id&gt;"</span> + QString::number(user-&gt;<a class="code" href="class_user.html#29cdee57f89b7c6f43eb656c7658ed60">usertype</a>);
<a name="l00075"></a>00075         qDebug() &lt;&lt; QString::number(user-&gt;<a class="code" href="class_user.html#29cdee57f89b7c6f43eb656c7658ed60">usertype</a>);
<a name="l00076"></a>00076         QSqlQuery query(sql);
<a name="l00077"></a>00077         query.exec();
<a name="l00078"></a>00078         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;query.numRowsAffected();++i){
<a name="l00079"></a>00079                 query.next();
<a name="l00080"></a>00080                 list.append(query.value(0).toString());
<a name="l00081"></a>00081         }
<a name="l00082"></a>00082         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#8710526a0d5b3dd714dc2991520a33e4">typComboBox</a>-&gt;addItems(list);
<a name="l00083"></a>00083         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#8710526a0d5b3dd714dc2991520a33e4">typComboBox</a>-&gt;setCurrentIndex(<a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#8710526a0d5b3dd714dc2991520a33e4">typComboBox</a>-&gt;findText(<span class="stringliteral">"manager"</span>));
<a name="l00084"></a>00084         <span class="comment">// Offset für ComboBox setzen</span>
<a name="l00085"></a>00085         <span class="keywordflow">if</span>(user-&gt;<a class="code" href="class_user.html#f6482cc57caa04a2c718fb059b2c1336" title="Gibt den Usertype zurück.">getUsertype</a>()==user-&gt;<a class="code" href="class_user.html#6f9db9ebdd86f9c93deff41f7b9193f155b52804af3433a9d28257d0a0a54eb3">administrator</a>)
<a name="l00086"></a>00086                         <a class="code" href="class_neuer_user_dialog.html#acbf834639fcd4aef2b62f69ea594eac">usertype_offset</a>=1;
<a name="l00087"></a>00087         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(user-&gt;<a class="code" href="class_user.html#f6482cc57caa04a2c718fb059b2c1336" title="Gibt den Usertype zurück.">getUsertype</a>()==user-&gt;<a class="code" href="class_user.html#6f9db9ebdd86f9c93deff41f7b9193f11813ae9ec397f1858dda882399516656">manager</a>)
<a name="l00088"></a>00088                         <a class="code" href="class_neuer_user_dialog.html#acbf834639fcd4aef2b62f69ea594eac">usertype_offset</a>=2;
<a name="l00089"></a>00089         <span class="comment">// Baum aufbauen</span>
<a name="l00090"></a>00090         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#2bcaa4e408397905be142139e5bd794d">streckenTreeWidget</a>-&gt;setColumnCount(4);
<a name="l00091"></a>00091         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#2bcaa4e408397905be142139e5bd794d">streckenTreeWidget</a>-&gt;setHeaderLabels(QStringList() &lt;&lt; tr(<span class="stringliteral">"Rennen"</span>) &lt;&lt; tr(<span class="stringliteral">"Startdatum"</span>)
<a name="l00092"></a>00092                         &lt;&lt; tr(<span class="stringliteral">"Enddatum"</span>) &lt;&lt; tr(<span class="stringliteral">"Streckennummer"</span>));
<a name="l00093"></a>00093         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#2bcaa4e408397905be142139e5bd794d">streckenTreeWidget</a>-&gt;header()-&gt;setResizeMode(0, QHeaderView::ResizeToContents);
<a name="l00094"></a>00094         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#2bcaa4e408397905be142139e5bd794d">streckenTreeWidget</a>-&gt;header()-&gt;setResizeMode(1, QHeaderView::ResizeToContents);
<a name="l00095"></a>00095         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#2bcaa4e408397905be142139e5bd794d">streckenTreeWidget</a>-&gt;header()-&gt;setResizeMode(2, QHeaderView::ResizeToContents);
<a name="l00096"></a>00096         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#2bcaa4e408397905be142139e5bd794d">streckenTreeWidget</a>-&gt;header()-&gt;setResizeMode(3, QHeaderView::ResizeToContents);
<a name="l00097"></a>00097         
<a name="l00098"></a>00098         <span class="comment">// ermögliche mehrfachauswahl</span>
<a name="l00099"></a>00099         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#2bcaa4e408397905be142139e5bd794d">streckenTreeWidget</a>-&gt;setSelectionMode(QAbstractItemView::MultiSelection);
<a name="l00100"></a>00100         
<a name="l00101"></a>00101         sql = <span class="stringliteral">"SELECT min(Jahr) FROM strecken"</span>;
<a name="l00102"></a>00102         query.exec(sql);
<a name="l00103"></a>00103         query.next();
<a name="l00104"></a>00104         <span class="keywordtype">int</span> min_jahr = query.value(0).toInt();
<a name="l00105"></a>00105         sql = <span class="stringliteral">"SELECT max(Jahr) FROM strecken"</span>;
<a name="l00106"></a>00106         query.prepare(sql);
<a name="l00107"></a>00107         query.exec();
<a name="l00108"></a>00108         query.next();
<a name="l00109"></a>00109         <span class="keywordtype">int</span> max_jahr = query.value(0).toInt();
<a name="l00110"></a>00110         
<a name="l00111"></a>00111         QTreeWidgetItem* act_year = NULL; <span class="comment">// Pointer auf aktuelles Jahr</span>
<a name="l00112"></a>00112         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> jahr=min_jahr; jahr&lt;=max_jahr; ++jahr){
<a name="l00113"></a>00113                 query.exec(<span class="stringliteral">"SELECT count(StreckenKey) FROM strecken WHERE Jahr='"</span> + QString::number(jahr) + <span class="stringliteral">"'"</span>);
<a name="l00114"></a>00114                 query.next();
<a name="l00115"></a>00115                 <span class="keywordflow">if</span>(query.value(0).toBool()){
<a name="l00116"></a>00116                         QTreeWidgetItem *root;
<a name="l00117"></a>00117                         root= <span class="keyword">new</span> QTreeWidgetItem(<a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#2bcaa4e408397905be142139e5bd794d">streckenTreeWidget</a>-&gt;invisibleRootItem());
<a name="l00118"></a>00118                         root-&gt;setText(0, QString::number(jahr));
<a name="l00119"></a>00119                         <span class="keywordflow">if</span>(QString::number(jahr)==QDate::currentDate().toString(<span class="stringliteral">"yyyy"</span>)){
<a name="l00120"></a>00120                                 <span class="comment">// Pointer auf WidgetItem für aktuelles Jahr</span>
<a name="l00121"></a>00121                                 act_year=root;
<a name="l00122"></a>00122                         }
<a name="l00123"></a>00123                         QTreeWidgetItem *item;
<a name="l00124"></a>00124                         sql = <span class="stringliteral">"SELECT StreckenKey, Streckenname, Startdatum, Enddatum, Jahr, StreckentypKey "</span>
<a name="l00125"></a>00125                                         <span class="stringliteral">"FROM strecken "</span>
<a name="l00126"></a>00126                                         <span class="stringliteral">"WHERE Jahr='"</span> + QString::number(jahr) + <span class="stringliteral">"'"</span>;
<a name="l00127"></a>00127                         qDebug() &lt;&lt; sql;
<a name="l00128"></a>00128                         query.prepare(sql);
<a name="l00129"></a>00129                         query.exec();
<a name="l00130"></a>00130                         <span class="keywordflow">if</span>(query.isActive()){
<a name="l00131"></a>00131                                 <span class="keywordtype">int</span> count = 0;
<a name="l00132"></a>00132                                 <span class="keywordflow">while</span>(query.next() &amp;&amp; user-&gt;<a class="code" href="class_user.html#1aa3e9682d94bd9c6c8d6c1e2d90d02a" title="Prüfen, ob der Benutzer die Berechtigung für ein Rennen hat.">getRaceAuthority</a>(query.value(0).toInt())){
<a name="l00133"></a>00133                                         item = <span class="keyword">new</span> QTreeWidgetItem(root);
<a name="l00134"></a>00134                                         item-&gt;setText(0,query.value(1).toString());
<a name="l00135"></a>00135                                         item-&gt;setText(1,query.value(2).toDate().toString(<span class="stringliteral">"dd.MM.yyyy"</span>));
<a name="l00136"></a>00136                                         item-&gt;setText(2,query.value(3).toDate().toString(<span class="stringliteral">"dd.MM.yyyy"</span>));
<a name="l00137"></a>00137                                         item-&gt;setText(3,QString::number(query.value(0).toInt()));
<a name="l00138"></a>00138                                         QIcon icon;
<a name="l00139"></a>00139                                         <span class="keywordflow">switch</span>(query.value(5).toInt()){
<a name="l00140"></a>00140                                                 <span class="keywordflow">case</span> <a class="code" href="class_neuer_user_dialog.html#082ce8ccd9b1a7c9856445d43ce793cc2d729f0c0aed41c25543a552440cbe3e">Rennvelo</a>: icon.addFile(<span class="stringliteral">":/images/rennrad.png"</span>); <span class="keywordflow">break</span>;
<a name="l00141"></a>00141                                                 <span class="keywordflow">case</span> <a class="code" href="class_neuer_user_dialog.html#082ce8ccd9b1a7c9856445d43ce793cc3cefb34589d488d0af6b64bd2b7906fb">Mountainbike</a>: icon.addFile(<span class="stringliteral">":/images/bike.png"</span>); <span class="keywordflow">break</span>;
<a name="l00142"></a>00142                                                 <span class="keywordflow">case</span> <a class="code" href="class_neuer_user_dialog.html#082ce8ccd9b1a7c9856445d43ce793cc4d2e41951b6b3ca8195716d1c21b6280">Laufen</a>: icon.addFile(<span class="stringliteral">":/images/plauf.png"</span>); <span class="keywordflow">break</span>;
<a name="l00143"></a>00143                                                 <span class="keywordflow">case</span> <a class="code" href="class_neuer_user_dialog.html#082ce8ccd9b1a7c9856445d43ce793cc9651254975c1086a510915966b1f4e2b">Walking</a>: icon.addFile(<span class="stringliteral">":/images/walking.png"</span>); <span class="keywordflow">break</span>;
<a name="l00144"></a>00144                                                 <span class="keywordflow">case</span> <a class="code" href="class_neuer_user_dialog.html#082ce8ccd9b1a7c9856445d43ce793cce9a227562de07b9e59787cf4944f55e9">Langlauf</a>: icon.addFile(<span class="stringliteral">":/images/langlauf.png"</span>); <span class="keywordflow">break</span>;
<a name="l00145"></a>00145                                                 <span class="keywordflow">case</span> <a class="code" href="class_neuer_user_dialog.html#082ce8ccd9b1a7c9856445d43ce793ccaf72dd6270ab5200ace99b5c70da5772">Inline</a>: icon.addFile(<span class="stringliteral">":/images/inline.png"</span>); <span class="keywordflow">break</span>;
<a name="l00146"></a>00146                                                 <span class="keywordflow">default</span>: icon.addFile(<span class="stringliteral">":/images/unbekannt.png"</span>); <span class="keywordflow">break</span>;
<a name="l00147"></a>00147                                         }
<a name="l00148"></a>00148                                         item-&gt;setIcon(0,icon);
<a name="l00149"></a>00149                                         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#2bcaa4e408397905be142139e5bd794d">streckenTreeWidget</a>-&gt;setCurrentItem(item);
<a name="l00150"></a>00150                                         count++;
<a name="l00151"></a>00151                                 }
<a name="l00152"></a>00152                                 <span class="keywordflow">if</span>(count == 0)
<a name="l00153"></a>00153                                         root-&gt;setHidden(<span class="keyword">true</span>);
<a name="l00154"></a>00154                         }
<a name="l00155"></a>00155                 }
<a name="l00156"></a>00156         }
<a name="l00157"></a>00157         <span class="comment">// Aktuelles Jahr expandieren</span>
<a name="l00158"></a>00158         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#2bcaa4e408397905be142139e5bd794d">streckenTreeWidget</a>-&gt;collapseAll();
<a name="l00159"></a>00159         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#2bcaa4e408397905be142139e5bd794d">streckenTreeWidget</a>-&gt;expandItem(act_year);
<a name="l00160"></a>00160         <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#2bcaa4e408397905be142139e5bd794d">streckenTreeWidget</a>-&gt;clearSelection ();
<a name="l00161"></a>00161 }
<a name="l00165"></a><a class="code" href="class_neuer_user_dialog.html#43abc0928f1c44d630543df0af87b99a">00165</a> <a class="code" href="class_neuer_user_dialog.html#43abc0928f1c44d630543df0af87b99a" title="Destruktor.">NeuerUserDialog::~NeuerUserDialog</a>()
<a name="l00166"></a>00166 {
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 }
<a name="l00169"></a>00169 
<a name="l00173"></a><a class="code" href="class_neuer_user_dialog.html#8efa7a01186a48c4b15abb986fc3388b">00173</a> <span class="keywordtype">void</span> <a class="code" href="class_neuer_user_dialog.html#8efa7a01186a48c4b15abb986fc3388b" title="Slot für OK-Button.">NeuerUserDialog::on_okButton_released</a>(){
<a name="l00174"></a>00174         <span class="keywordtype">char</span> md5_password_char [17];
<a name="l00175"></a>00175         <span class="comment">// Validieren der Einträge</span>
<a name="l00176"></a>00176         <span class="keywordflow">if</span>(!<a class="code" href="class_neuer_user_dialog.html#6b115697c371d742e48926b7f084ef5e" title="Validierung der Einträge.">validation</a>())
<a name="l00177"></a>00177                 <span class="keywordflow">return</span>;
<a name="l00178"></a>00178         <span class="comment">// Benutzername testen</span>
<a name="l00179"></a>00179         QSqlQuery query;
<a name="l00180"></a>00180         query.exec(<span class="stringliteral">"SELECT username FROM user WHERE username='"</span> + <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#ee98382add2320120c64b7c1ac79e4dc">usernameLineEdit</a>-&gt;text() + <span class="stringliteral">"'"</span>);
<a name="l00181"></a>00181         <span class="keywordflow">if</span>(query.numRowsAffected()!=0){
<a name="l00182"></a>00182                 <span class="comment">// Benutzername bereits vergeben</span>
<a name="l00183"></a>00183                 QMessageBox::critical(<span class="keyword">this</span>, QObject::tr(<span class="stringliteral">"Benutzername"</span>),QObject::tr(<span class="stringliteral">"Dieser Benutzername ist bereits vorhanden! Erhöhen Sie die Nummer am Ende des Namens."</span>));
<a name="l00184"></a>00184                 <span class="keywordflow">return</span>;
<a name="l00185"></a>00185         }
<a name="l00186"></a>00186         <span class="comment">// Passwörter vergleichen</span>
<a name="l00187"></a>00187         <span class="keywordflow">if</span>(<a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#ac993e337eddb7945b3a93fdcc06572d">pwdLineEdit</a>-&gt;text().compare(<a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#41b5e6f827c399209e918157bd1035d6">pwdwLineEdit</a>-&gt;text())!=0){
<a name="l00188"></a>00188                 QMessageBox::critical(<span class="keyword">this</span>, QObject::tr(<span class="stringliteral">"Fehler"</span>),QObject::tr(<span class="stringliteral">"Geben Sie zweimal dasselbe Passwort ein!"</span>));
<a name="l00189"></a>00189                 <span class="comment">// zurück zum Eingabedialog</span>
<a name="l00190"></a>00190                 <span class="keywordflow">return</span>;         
<a name="l00191"></a>00191         }
<a name="l00192"></a>00192         <span class="comment">// Abfrage des Adminpasswortes</span>
<a name="l00193"></a>00193         QString pwd = QInputDialog::getText(<span class="keyword">this</span>, tr(<span class="stringliteral">"Identifizierung als Administrator"</span>),
<a name="l00194"></a>00194                                                   tr(<span class="stringliteral">"Passwort des angemeldeten Administrators:"</span>), 
<a name="l00195"></a>00195                                                   QLineEdit::Password);
<a name="l00196"></a>00196         <span class="comment">// Passwortabfrage zur Identifikation - MD5-Hash</span>
<a name="l00197"></a>00197         <span class="keywordflow">if</span>(!pwd.isEmpty()){
<a name="l00198"></a>00198                 <a class="code" href="md5_8cpp.html#f5de8c04dba53defbfbdd955ca7d19ab">md5_buffer</a>(pwd.toAscii().data(),pwd.length(),md5_password_char);
<a name="l00199"></a>00199                 pwd = QByteArray::fromRawData(md5_password_char,16).toHex(); 
<a name="l00200"></a>00200                 <span class="keywordflow">if</span>(<a class="code" href="class_neuer_user_dialog.html#4f0a500dbb82eb6f8c7ca521aab8f332">pUser</a>-&gt;<a class="code" href="class_user.html#c887622f22a898c097d156ad964be846">password</a>.compare(pwd)!=0){
<a name="l00201"></a>00201                         <span class="comment">// Zurück zum Eingabe Dialog</span>
<a name="l00202"></a>00202                         QMessageBox::critical(<span class="keyword">this</span>, QObject::tr(<span class="stringliteral">"Passwortabfrage"</span>),QObject::tr(<span class="stringliteral">"Das Passwort war nicht Korrekt!"</span>));
<a name="l00203"></a>00203                         <span class="keywordflow">return</span>;
<a name="l00204"></a>00204                 }
<a name="l00205"></a>00205         }<span class="keywordflow">else</span>{
<a name="l00206"></a>00206                 QMessageBox::critical(<span class="keyword">this</span>, QObject::tr(<span class="stringliteral">"Fehler"</span>),QObject::tr(<span class="stringliteral">"Sie haben kein Passwort eingegeben!"</span>));
<a name="l00207"></a>00207                 <span class="keywordflow">return</span>;
<a name="l00208"></a>00208         }
<a name="l00209"></a>00209         
<a name="l00210"></a>00210         <span class="comment">// Erstellen des Strings für die Berechtigungen</span>
<a name="l00211"></a>00211         QList&lt;QTreeWidgetItem*&gt; list = <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#2bcaa4e408397905be142139e5bd794d">streckenTreeWidget</a>-&gt;selectedItems();
<a name="l00212"></a>00212         QString rights;
<a name="l00213"></a>00213         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;list.count();++i){
<a name="l00214"></a>00214                 rights += list.at(i)-&gt;data(3,Qt::DisplayRole).toString() + <span class="stringliteral">";"</span>;
<a name="l00215"></a>00215         }
<a name="l00216"></a>00216         rights.chop(1); <span class="comment">// letzter ';' wegschneiden</span>
<a name="l00217"></a>00217         qDebug() &lt;&lt; rights;
<a name="l00218"></a>00218         
<a name="l00219"></a>00219         <span class="comment">// MD5-hash vom Passwort des Users erstellen</span>
<a name="l00220"></a>00220         QString userpwd = <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#ac993e337eddb7945b3a93fdcc06572d">pwdLineEdit</a>-&gt;text();
<a name="l00221"></a>00221         <a class="code" href="md5_8cpp.html#f5de8c04dba53defbfbdd955ca7d19ab">md5_buffer</a>(userpwd.toAscii().data(),userpwd.length(),md5_password_char);
<a name="l00222"></a>00222         userpwd = QByteArray::fromRawData(md5_password_char,16).toHex(); 
<a name="l00223"></a>00223         
<a name="l00224"></a>00224         <span class="comment">// Eintragen der neuen Daten</span>
<a name="l00225"></a>00225         QString sql = <span class="stringliteral">"INSERT INTO user ("</span>
<a name="l00226"></a>00226                         <span class="stringliteral">"UserKey, username, name, email, password, usertype, Rennen "</span>
<a name="l00227"></a>00227                         <span class="stringliteral">")VALUES( NULL, "</span>;
<a name="l00228"></a>00228         sql += <span class="stringliteral">"'"</span> + <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#ee98382add2320120c64b7c1ac79e4dc">usernameLineEdit</a>-&gt;text() + <span class="stringliteral">"', "</span>;
<a name="l00229"></a>00229         sql += <span class="stringliteral">"'"</span> + <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#5d7ac7d442a96686d9fa74ea43e9fe83">nameLineEdit</a>-&gt;text() + <span class="stringliteral">"', "</span>;
<a name="l00230"></a>00230         sql += <span class="stringliteral">"'"</span> + <a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#05a279f8550cee40c692ae767f1331db">emailLineEdit</a>-&gt;text() + <span class="stringliteral">"', "</span>;
<a name="l00231"></a>00231         sql += <span class="stringliteral">"'"</span> + userpwd + <span class="stringliteral">"', "</span>;
<a name="l00232"></a>00232         sql += <span class="stringliteral">"'"</span> + QString::number(<a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#8710526a0d5b3dd714dc2991520a33e4">typComboBox</a>-&gt;currentIndex()+<a class="code" href="class_neuer_user_dialog.html#acbf834639fcd4aef2b62f69ea594eac">usertype_offset</a>+1) + <span class="stringliteral">"', "</span>;
<a name="l00233"></a>00233         sql += <span class="stringliteral">"'"</span> + rights + <span class="stringliteral">"')"</span>;
<a name="l00234"></a>00234         qDebug() &lt;&lt; sql;
<a name="l00235"></a>00235         query.exec(<span class="stringliteral">"LOCK TABLES user WRITE"</span>);
<a name="l00236"></a>00236         query.exec(sql);
<a name="l00237"></a>00237         query.exec(<span class="stringliteral">"UNLOCK TABLES"</span>);
<a name="l00238"></a>00238         qDebug() &lt;&lt; query.lastError();
<a name="l00239"></a>00239         this-&gt;close();  
<a name="l00240"></a>00240 }
<a name="l00241"></a>00241 
<a name="l00245"></a><a class="code" href="class_neuer_user_dialog.html#fd1184d0212d7fda723c67a29d09093a">00245</a> <span class="keywordtype">void</span> <a class="code" href="class_neuer_user_dialog.html#fd1184d0212d7fda723c67a29d09093a" title="Slot für Abbrechen-Button.">NeuerUserDialog::on_canButton_released</a>(){
<a name="l00246"></a>00246         <span class="comment">// Fenster schliessen</span>
<a name="l00247"></a>00247         this-&gt;close();
<a name="l00248"></a>00248 }
<a name="l00249"></a>00249 
<a name="l00253"></a><a class="code" href="class_neuer_user_dialog.html#6b115697c371d742e48926b7f084ef5e">00253</a> <span class="keywordtype">bool</span> <a class="code" href="class_neuer_user_dialog.html#6b115697c371d742e48926b7f084ef5e" title="Validierung der Einträge.">NeuerUserDialog::validation</a>(){
<a name="l00254"></a>00254         <span class="keywordtype">bool</span> valid = <span class="keyword">true</span>;
<a name="l00255"></a>00255         QString error = <span class="stringliteral">"Die folgenden Felder benötigen noch einen Inhalt:\n"</span>;
<a name="l00256"></a>00256         <span class="keywordflow">if</span>(<a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#ee98382add2320120c64b7c1ac79e4dc">usernameLineEdit</a>-&gt;text()==<span class="stringliteral">""</span>){
<a name="l00257"></a>00257                 error += <span class="stringliteral">"Benutzername, "</span>;
<a name="l00258"></a>00258                 valid = <span class="keyword">false</span>;
<a name="l00259"></a>00259         }
<a name="l00260"></a>00260         <span class="keywordflow">if</span>(<a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#5d7ac7d442a96686d9fa74ea43e9fe83">nameLineEdit</a>-&gt;text()==<span class="stringliteral">""</span>){
<a name="l00261"></a>00261                 error += <span class="stringliteral">"Name, "</span>;
<a name="l00262"></a>00262                 valid = <span class="keyword">false</span>;
<a name="l00263"></a>00263         }
<a name="l00264"></a>00264         <span class="keywordflow">if</span>(<a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#ac993e337eddb7945b3a93fdcc06572d">pwdLineEdit</a>-&gt;text()==<span class="stringliteral">""</span>){
<a name="l00265"></a>00265                 error += <span class="stringliteral">"Passwort, "</span>;
<a name="l00266"></a>00266                 valid = <span class="keyword">false</span>;
<a name="l00267"></a>00267         }
<a name="l00268"></a>00268         <span class="keywordflow">if</span>(<a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#41b5e6f827c399209e918157bd1035d6">pwdwLineEdit</a>-&gt;text()==<span class="stringliteral">""</span>){
<a name="l00269"></a>00269                 error += <span class="stringliteral">"Passwort wiederholen, "</span>;
<a name="l00270"></a>00270                 valid = <span class="keyword">false</span>;
<a name="l00271"></a>00271         }
<a name="l00272"></a>00272         <span class="keywordflow">if</span>(<a class="code" href="class_neuer_user_dialog.html#3f6bb409584c450d6ca87973eb0c31b1">ui</a>.<a class="code" href="class_ui___neuer_user_dialog_class.html#05a279f8550cee40c692ae767f1331db">emailLineEdit</a>-&gt;text()==<span class="stringliteral">""</span>){
<a name="l00273"></a>00273                 error += <span class="stringliteral">"E-Mail, "</span>;
<a name="l00274"></a>00274                 valid = <span class="keyword">false</span>;
<a name="l00275"></a>00275         }
<a name="l00276"></a>00276         <span class="comment">// entfernt 2 Zeichen am Ende des Strings</span>
<a name="l00277"></a>00277         error.chop(2);
<a name="l00278"></a>00278         <span class="keywordflow">if</span>(!valid)
<a name="l00279"></a>00279                 QMessageBox::critical(0,QObject::tr(<span class="stringliteral">"Fehlende Einträge"</span>),error);
<a name="l00280"></a>00280         <span class="keywordflow">return</span> valid;
<a name="l00281"></a>00281 }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Jun 30 09:36:03 2008 for BEO-Timing by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
