<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>BEO-Timing: RFID_Reader/RFID_CR500.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>RFID_Reader/RFID_CR500.cpp</h1><a href="_r_f_i_d___c_r500_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;windows.h&gt;</span> 
<a name="l00033"></a>00033 <span class="preprocessor">#include "<a class="code" href="beo__timing_8h.html" title="Hauptklasse der Applikation.">beo_timing.h</a>"</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include "<a class="code" href="_master_r_d_8h.html" title="Headerdatei für die DLL des RFID-Lesers CR500-USB.">RFID_Reader/MasterRD.h</a>"</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;QtGui&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;QtSql&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include "<a class="code" href="_r_f_i_d___c_r500_8h.html" title="Enthält alle Eigenschaften des RFID-Lesers CR500-USB.">RFID_Reader/RFID_CR500.h</a>"</span>
<a name="l00038"></a>00038 
<a name="l00042"></a><a class="code" href="class_r_f_i_d___c_r500.html#2d028be0db1277a8feca1cfbd4f5619e">00042</a> <a class="code" href="class_r_f_i_d___c_r500.html#2d028be0db1277a8feca1cfbd4f5619e" title="Konstruktor.">RFID_CR500::RFID_CR500</a>()
<a name="l00043"></a>00043 {
<a name="l00044"></a>00044         <a class="code" href="class_r_f_i_d___c_r500.html#ce1fec5794623260b5e697762899bc73" title="Initialisieren des RFID-Lesers.">init_RFID</a>();
<a name="l00045"></a>00045         <a class="code" href="class_r_f_i_d___c_r500.html#40862a8ca6eeaf91bb5974f17641285a">connected</a>=<span class="keyword">false</span>;
<a name="l00046"></a>00046         <span class="comment">// auf allen 8 COM-Port versuchen zu Verbinden</span>
<a name="l00047"></a>00047         <span class="keywordflow">while</span>(!<a class="code" href="class_r_f_i_d___c_r500.html#40862a8ca6eeaf91bb5974f17641285a">connected</a>){
<a name="l00048"></a>00048                 <span class="keywordtype">int</span> state = 1;
<a name="l00049"></a>00049                 <span class="keywordtype">int</span> i = 1;
<a name="l00050"></a>00050                 <span class="keywordflow">while</span>(state != 0 &amp;&amp; i&lt;8){
<a name="l00051"></a>00051                         state = rf_init_com(i,19200);
<a name="l00052"></a>00052                         i++;
<a name="l00053"></a>00053                 }
<a name="l00054"></a>00054                 <span class="keywordflow">if</span>(state != <a class="code" href="_master_r_d_8h.html#12e8fdb03bab94cb4feea8dce4d706ec">LIB_SUCCESS</a>){
<a name="l00055"></a>00055                         rf_ClosePort();                 
<a name="l00056"></a>00056                         qDebug() &lt;&lt; <span class="stringliteral">"Nicht im Bereich von COM1...8!"</span> &lt;&lt; endl;
<a name="l00057"></a>00057                         QMessageBox msgBox;
<a name="l00058"></a>00058                         QPushButton *wiederholenButton = msgBox.addButton(QObject::tr(<span class="stringliteral">"Wiederholen"</span>), QMessageBox::ActionRole);
<a name="l00059"></a>00059                         QPushButton *abbrechenButton = msgBox.addButton(QObject::tr(<span class="stringliteral">"Abbrechen"</span>), QMessageBox::ActionRole);
<a name="l00060"></a>00060                         msgBox.setDefaultButton(wiederholenButton);
<a name="l00061"></a>00061                         msgBox.setEscapeButton(wiederholenButton);
<a name="l00062"></a>00062                         msgBox.setText(QObject::tr(<span class="stringliteral">"Die Verbindung zum RFID-Leser konte nicht hergestellt werden.\n"</span>
<a name="l00063"></a>00063                                                                                 <span class="stringliteral">"Zur Fehlerbehebung gehen Sie wie folgt vor:\n"</span>
<a name="l00064"></a>00064                                                                                 <span class="stringliteral">"1. Ziehen Sie den Leser aus und stecken Sie ihn wieder ein.\n"</span>
<a name="l00065"></a>00065                                                                                 <span class="stringliteral">"2. Stellen Sie sicher, dass der COM-Port im Bereich von 1-8 liegt.\n"</span>
<a name="l00066"></a>00066                                                                                 <span class="stringliteral">"3. Stellen Sie sicher, dass die Treiber korrekt installiert sind.\n"</span>));
<a name="l00067"></a>00067                         msgBox.setWindowTitle(QObject::tr(<span class="stringliteral">"Verbindungsfehler (RFID-Leser)"</span>));
<a name="l00068"></a>00068                         msgBox.setIcon(QMessageBox::Warning);
<a name="l00069"></a>00069                         msgBox.exec();
<a name="l00070"></a>00070                         <span class="keywordflow">if</span> (msgBox.clickedButton()==abbrechenButton) {
<a name="l00071"></a>00071                                 <span class="keywordflow">break</span>;
<a name="l00072"></a>00072                         }
<a name="l00073"></a>00073                 }<span class="keywordflow">else</span>{
<a name="l00074"></a>00074                         <a class="code" href="class_r_f_i_d___c_r500.html#40862a8ca6eeaf91bb5974f17641285a">connected</a>=<span class="keyword">true</span>;
<a name="l00075"></a>00075                 }
<a name="l00076"></a>00076         }
<a name="l00077"></a>00077         <span class="comment">// Devicenummer abrufen</span>
<a name="l00078"></a>00078         rf_get_device_number(&amp;<a class="code" href="class_r_f_i_d___c_r500.html#db93e027f9415df3008e43478a9bdaed">icdev</a>);
<a name="l00079"></a>00079         qDebug() &lt;&lt; <span class="stringliteral">"Nummer des Lesers: "</span> + <a class="code" href="class_r_f_i_d___c_r500.html#db93e027f9415df3008e43478a9bdaed">icdev</a>;
<a name="l00080"></a>00080         <span class="comment">// Piepsem mit dem Leser</span>
<a name="l00081"></a>00081         rf_beep(<a class="code" href="class_r_f_i_d___c_r500.html#db93e027f9415df3008e43478a9bdaed">icdev</a>,10); 
<a name="l00082"></a>00082         <span class="comment">// Licht auf Grün</span>
<a name="l00083"></a>00083         rf_light(<a class="code" href="class_r_f_i_d___c_r500.html#db93e027f9415df3008e43478a9bdaed">icdev</a>,<a class="code" href="_r_f_i_d___c_r500_8h.html#99fb83031ce9923c84392b4e92f956b5c9da5c4501ff07f5930282709dec61b3">GREEN_LED</a>);
<a name="l00084"></a>00084         <span class="comment">// Statusleiste aktualisieren</span>
<a name="l00085"></a>00085         <a class="code" href="class_b_e_o___timing.html#394c0e847c9a363fd1eb8c1e00404115">BEO_Timing::updateRFID</a>(<span class="stringliteral">"CR500"</span>);
<a name="l00086"></a>00086         <a class="code" href="class_b_e_o___timing.html#ab6e90f89fdd1a266ef14556a97c4212">BEO_Timing::updateMessage</a>(<span class="stringliteral">"RFID-Leser verbunden"</span>);
<a name="l00087"></a>00087 }
<a name="l00091"></a><a class="code" href="class_r_f_i_d___c_r500.html#766c86b545f284a11e285305e88cd97a">00091</a> <a class="code" href="class_r_f_i_d___c_r500.html#766c86b545f284a11e285305e88cd97a" title="Destruktor.">RFID_CR500::~RFID_CR500</a>()
<a name="l00092"></a>00092 {
<a name="l00093"></a>00093         rf_ClosePort();
<a name="l00094"></a>00094 }
<a name="l00098"></a><a class="code" href="class_r_f_i_d___c_r500.html#04bf682d670036b022d674c96a855140">00098</a> <span class="keywordtype">void</span> <a class="code" href="class_r_f_i_d___c_r500.html#04bf682d670036b022d674c96a855140" title="Strcat für UTF-8.">RFID_CR500::myStrcat</a> (TCHAR * op, <span class="keywordtype">int</span> size) {
<a name="l00099"></a>00099         <span class="keywordtype">int</span> i;
<a name="l00100"></a>00100         <span class="keywordflow">for</span> (i=size-1;i&gt;=0;i--) {
<a name="l00101"></a>00101                 <span class="keywordflow">if</span> (op[i]== (TCHAR)<span class="charliteral">'\\'</span>) 
<a name="l00102"></a>00102                         <span class="keywordflow">break</span>;
<a name="l00103"></a>00103         }
<a name="l00104"></a>00104         op[i++]=(TCHAR)<span class="charliteral">'\\'</span>;
<a name="l00105"></a>00105         op[i++]=(TCHAR)<span class="charliteral">'M'</span>;
<a name="l00106"></a>00106         op[i++]=(TCHAR)<span class="charliteral">'a'</span>;
<a name="l00107"></a>00107         op[i++]=(TCHAR)<span class="charliteral">'s'</span>;
<a name="l00108"></a>00108         op[i++]=(TCHAR)<span class="charliteral">'t'</span>;
<a name="l00109"></a>00109         op[i++]=(TCHAR)<span class="charliteral">'e'</span>;
<a name="l00110"></a>00110         op[i++]=(TCHAR)<span class="charliteral">'r'</span>;
<a name="l00111"></a>00111         op[i++]=(TCHAR)<span class="charliteral">'R'</span>;
<a name="l00112"></a>00112         op[i++]=(TCHAR)<span class="charliteral">'D'</span>;
<a name="l00113"></a>00113         op[i++]=(TCHAR)<span class="charliteral">'.'</span>;
<a name="l00114"></a>00114         op[i++]=(TCHAR)<span class="charliteral">'d'</span>;
<a name="l00115"></a>00115         op[i++]=(TCHAR)<span class="charliteral">'l'</span>;
<a name="l00116"></a>00116         op[i++]=(TCHAR)<span class="charliteral">'l'</span>;
<a name="l00117"></a>00117         op[i++]=(TCHAR)<span class="charliteral">'\0'</span>;
<a name="l00118"></a>00118 }
<a name="l00122"></a><a class="code" href="class_r_f_i_d___c_r500.html#45353483301fecf71b2c2d0c386e30e2">00122</a> <span class="keywordtype">void</span> <a class="code" href="class_r_f_i_d___c_r500.html#45353483301fecf71b2c2d0c386e30e2" title="Ausgabe für UTF-8 String.">RFID_CR500::myCout</a> (TCHAR * op, <span class="keywordtype">int</span> size){
<a name="l00123"></a>00123         <span class="keywordtype">char</span> out[1000];
<a name="l00124"></a>00124         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;size;i++){
<a name="l00125"></a>00125                 out[i]=(char)op[i];
<a name="l00126"></a>00126                 <span class="keywordflow">if</span>(op[i]==0)
<a name="l00127"></a>00127                         <span class="keywordflow">break</span>;
<a name="l00128"></a>00128         }
<a name="l00129"></a>00129         qDebug() &lt;&lt; QString::fromWCharArray(op);
<a name="l00130"></a>00130         qDebug() &lt;&lt; out &lt;&lt; endl;
<a name="l00131"></a>00131 } 
<a name="l00135"></a><a class="code" href="class_r_f_i_d___c_r500.html#ce1fec5794623260b5e697762899bc73">00135</a> <span class="keywordtype">void</span> <a class="code" href="class_r_f_i_d___c_r500.html#ce1fec5794623260b5e697762899bc73" title="Initialisieren des RFID-Lesers.">RFID_CR500::init_RFID</a>(){
<a name="l00136"></a>00136         HINSTANCE m_hInstMaster;
<a name="l00137"></a>00137         TCHAR szBuf[1000];      
<a name="l00138"></a>00138         GetModuleFileName(NULL, (LPTSTR)szBuf, 1000);
<a name="l00139"></a>00139         qDebug() &lt;&lt; <span class="keyword">sizeof</span>(szBuf) &lt;&lt; endl;
<a name="l00140"></a>00140         
<a name="l00141"></a>00141         <a class="code" href="class_r_f_i_d___c_r500.html#04bf682d670036b022d674c96a855140" title="Strcat für UTF-8.">myStrcat</a>(szBuf, <span class="keyword">sizeof</span>(szBuf)/<span class="keyword">sizeof</span>(TCHAR));
<a name="l00142"></a>00142         <a class="code" href="class_r_f_i_d___c_r500.html#45353483301fecf71b2c2d0c386e30e2" title="Ausgabe für UTF-8 String.">myCout</a>(szBuf, <span class="keyword">sizeof</span>(szBuf)/<span class="keyword">sizeof</span>(TCHAR));
<a name="l00143"></a>00143         <span class="comment">// Laden der "MasterRD.dll" über die Windows-API</span>
<a name="l00144"></a>00144         m_hInstMaster = LoadLibrary((LPTSTR)szBuf);      
<a name="l00145"></a>00145         <span class="comment">// Bereitstellen der Adressen für die Funktionen in der DLL</span>
<a name="l00146"></a>00146         <span class="keywordflow">if</span>(m_hInstMaster){
<a name="l00147"></a>00147         <span class="comment">/*  System Functions */</span>
<a name="l00148"></a>00148                 (FARPROC&amp;)lib_ver               = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"lib_ver"</span>));
<a name="l00149"></a>00149                 (FARPROC&amp;)rf_init_com           = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_init_com"</span>));
<a name="l00150"></a>00150                 (FARPROC&amp;)rf_init_device_number = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_init_device_number"</span>));
<a name="l00151"></a>00151                 (FARPROC&amp;)rf_get_device_number  = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_get_device_number"</span>));
<a name="l00152"></a>00152                 (FARPROC&amp;)rf_get_model          = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_get_model"</span>));
<a name="l00153"></a>00153                 (FARPROC&amp;)rf_beep               = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_beep"</span>));
<a name="l00154"></a>00154                 (FARPROC&amp;)rf_init_type          = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_init_type"</span>));
<a name="l00155"></a>00155                 (FARPROC&amp;)rf_antenna_sta        = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_antenna_sta"</span>));
<a name="l00156"></a>00156                 (FARPROC&amp;)rf_light              = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_light"</span>));
<a name="l00157"></a>00157                 (FARPROC&amp;)rf_ClosePort          = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_ClosePort"</span>));
<a name="l00158"></a>00158                 (FARPROC&amp;)rf_get_snr            = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_get_snr"</span>));
<a name="l00159"></a>00159                 (FARPROC&amp;)rf_init_sam           = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_init_sam"</span>));
<a name="l00160"></a>00160                 (FARPROC&amp;)rf_sam_rst            = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_sam_rst"</span>));
<a name="l00161"></a>00161                 (FARPROC&amp;)rf_sam_cos            = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_sam_cos"</span>));
<a name="l00162"></a>00162                 (FARPROC&amp;)rf_GetErrorMessage    = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_GetErrorMessage"</span>));
<a name="l00163"></a>00163                 <span class="comment">/* DES Functions */</span>
<a name="l00164"></a>00164                 (FARPROC&amp;)des_encrypt           = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"des_encrypt"</span>));
<a name="l00165"></a>00165                 (FARPROC&amp;)des_decrypt           = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"des_decrypt"</span>));                                
<a name="l00166"></a>00166                 <span class="comment">/* ISO14443A FUNCTION -  Mifare UltraLight */</span>
<a name="l00167"></a>00167                 (FARPROC&amp;)rf_request            = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_request"</span>));
<a name="l00168"></a>00168                 (FARPROC&amp;)rf_ul_select          = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_ul_select"</span>));
<a name="l00169"></a>00169                 (FARPROC&amp;)rf_M1_read            = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_M1_read"</span>));
<a name="l00170"></a>00170                 (FARPROC&amp;)rf_ul_write           = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_ul_write"</span>));
<a name="l00171"></a>00171                 (FARPROC&amp;)rf_halt               = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_halt"</span>));
<a name="l00172"></a>00172                 <span class="comment">/* ISO14443A FUNCTION -  Mifare Std*/</span>
<a name="l00173"></a>00173                 (FARPROC&amp;)rf_anticoll           = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_anticoll"</span>));
<a name="l00174"></a>00174                 (FARPROC&amp;)rf_select             = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_select"</span>));
<a name="l00175"></a>00175                 (FARPROC&amp;)rf_download_key       = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_download_key"</span>));
<a name="l00176"></a>00176                 (FARPROC&amp;)rf_M1_authentication1 = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_M1_authentication1"</span>));
<a name="l00177"></a>00177                 (FARPROC&amp;)rf_M1_authentication2 = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_M1_authentication2"</span>));
<a name="l00178"></a>00178                 (FARPROC&amp;)rf_M1_write           = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_M1_write"</span>));
<a name="l00179"></a>00179                 (FARPROC&amp;)rf_M1_initval         = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_M1_initval"</span>));
<a name="l00180"></a>00180                 (FARPROC&amp;)rf_M1_readval         = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_M1_readval"</span>));
<a name="l00181"></a>00181                 (FARPROC&amp;)rf_M1_decrement       = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_M1_decrement"</span>));
<a name="l00182"></a>00182                 (FARPROC&amp;)rf_M1_increment       = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_M1_increment"</span>));
<a name="l00183"></a>00183                 (FARPROC&amp;)rf_M1_restore         = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_M1_restore"</span>));
<a name="l00184"></a>00184                 (FARPROC&amp;)rf_M1_transfer        = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_M1_transfer"</span>));
<a name="l00185"></a>00185                 (FARPROC&amp;)rf_typea_rst          = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_typea_rst"</span>));
<a name="l00186"></a>00186                 (FARPROC&amp;)rf_cos_command        = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_cos_command"</span>));
<a name="l00187"></a>00187                 (FARPROC&amp;)rf_atqb               = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_atqb"</span>));
<a name="l00188"></a>00188                 (FARPROC&amp;)rf_attrib             = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_attrib"</span>));
<a name="l00189"></a>00189                 (FARPROC&amp;)rf_typeb_cos          = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_typeb_cos"</span>));
<a name="l00190"></a>00190                 (FARPROC&amp;)rf_hltb               = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_hltb"</span>));
<a name="l00191"></a>00191                 (FARPROC&amp;)rf_at020_check        = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_at020_check"</span>));
<a name="l00192"></a>00192                 (FARPROC&amp;)rf_at020_read         = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_at020_read"</span>));
<a name="l00193"></a>00193                 (FARPROC&amp;)rf_at020_write        = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_at020_write"</span>));
<a name="l00194"></a>00194                 (FARPROC&amp;)rf_at020_lock         = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_at020_lock"</span>));
<a name="l00195"></a>00195                 (FARPROC&amp;)rf_at020_count        = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_at020_count"</span>));
<a name="l00196"></a>00196                 (FARPROC&amp;)rf_at020_deselect     = GetProcAddress(m_hInstMaster,(<span class="stringliteral">"rf_at020_deselect"</span>));
<a name="l00197"></a>00197                 <span class="comment">// Testen der Adressen </span>
<a name="l00198"></a>00198                 <span class="keywordflow">if</span>( <span class="comment">/* System Functions */</span>
<a name="l00199"></a>00199                     NULL == lib_ver               ||
<a name="l00200"></a>00200                         NULL == rf_init_com           ||
<a name="l00201"></a>00201                         NULL == rf_init_device_number ||
<a name="l00202"></a>00202                         NULL == rf_get_device_number  ||
<a name="l00203"></a>00203                         NULL == rf_get_model              ||
<a name="l00204"></a>00204                         NULL == rf_beep                           ||
<a name="l00205"></a>00205                         NULL == rf_antenna_sta        ||
<a name="l00206"></a>00206                         NULL == rf_light              ||
<a name="l00207"></a>00207                         NULL == rf_ClosePort          ||
<a name="l00208"></a>00208                         NULL == rf_get_snr            ||
<a name="l00209"></a>00209                         NULL == rf_init_type          ||
<a name="l00210"></a>00210                         NULL == rf_init_sam           ||
<a name="l00211"></a>00211                         NULL == rf_sam_rst            ||
<a name="l00212"></a>00212                         NULL == rf_sam_cos            ||
<a name="l00213"></a>00213                         NULL == rf_GetErrorMessage        ||
<a name="l00214"></a>00214                         <span class="comment">/* DES Functions */</span>
<a name="l00215"></a>00215                         NULL == des_encrypt           ||
<a name="l00216"></a>00216                         NULL == des_decrypt           ||
<a name="l00217"></a>00217                         <span class="comment">/* ISO14443A FUNCTION -  Mifare UltraLight */</span>
<a name="l00218"></a>00218                         NULL == rf_request            ||
<a name="l00219"></a>00219                         NULL == rf_ul_select          ||
<a name="l00220"></a>00220                         NULL == rf_M1_read            ||
<a name="l00221"></a>00221                         NULL == rf_ul_write           ||
<a name="l00222"></a>00222                         NULL == rf_halt               ||
<a name="l00223"></a>00223                         <span class="comment">/* ISO14443A FUNCTION -  Mifare Std */</span>
<a name="l00224"></a>00224                         NULL == rf_anticoll           ||
<a name="l00225"></a>00225                         NULL == rf_select             ||
<a name="l00226"></a>00226                         NULL == rf_download_key       ||
<a name="l00227"></a>00227                         NULL == rf_M1_authentication1 ||
<a name="l00228"></a>00228                         NULL == rf_M1_authentication2 ||
<a name="l00229"></a>00229                         NULL == rf_M1_write           ||
<a name="l00230"></a>00230                         NULL == rf_M1_initval         ||
<a name="l00231"></a>00231                         NULL == rf_M1_readval         ||
<a name="l00232"></a>00232                         NULL == rf_M1_decrement       ||
<a name="l00233"></a>00233                         NULL == rf_M1_increment       ||
<a name="l00234"></a>00234                         NULL == rf_M1_restore         ||
<a name="l00235"></a>00235                         NULL == rf_M1_transfer        ||
<a name="l00236"></a>00236                         NULL == rf_typea_rst          ||
<a name="l00237"></a>00237                         NULL == rf_cos_command        ||
<a name="l00238"></a>00238                         NULL == rf_atqb               ||
<a name="l00239"></a>00239                         NULL == rf_attrib             ||
<a name="l00240"></a>00240                         NULL == rf_typeb_cos          ||
<a name="l00241"></a>00241                         NULL == rf_hltb               ||
<a name="l00242"></a>00242                         NULL == rf_at020_check        ||
<a name="l00243"></a>00243                         NULL == rf_at020_read         ||
<a name="l00244"></a>00244                         NULL == rf_at020_write        ||
<a name="l00245"></a>00245                         NULL == rf_at020_lock         ||
<a name="l00246"></a>00246                         NULL == rf_at020_count        ||
<a name="l00247"></a>00247                         NULL == rf_at020_deselect){
<a name="l00248"></a>00248                         qDebug() &lt;&lt; <span class="stringliteral">"Load MasterRD.dll failed !"</span>;
<a name="l00249"></a>00249                 }
<a name="l00250"></a>00250         }
<a name="l00251"></a>00251         <span class="keywordflow">else</span>{
<a name="l00252"></a>00252                 qDebug() &lt;&lt; <span class="stringliteral">"Load MasterRD.dll failed !"</span>;
<a name="l00253"></a>00253         
<a name="l00254"></a>00254         }
<a name="l00255"></a>00255 }
<a name="l00259"></a><a class="code" href="class_r_f_i_d___c_r500.html#7d3f44b888f7da7cea83111f41bb6d95">00259</a> <span class="keywordtype">bool</span> <a class="code" href="class_r_f_i_d___c_r500.html#7d3f44b888f7da7cea83111f41bb6d95" title="Karte im Feld suchen.">RFID_CR500::findCard</a>(){
<a name="l00260"></a>00260         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="_master_r_d_8h.html#74b654271a172a244c844fb86277cd8a">mode</a> = 0x52;
<a name="l00261"></a>00261         <span class="keywordtype">int</span> status;
<a name="l00262"></a>00262         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="_master_r_d_8h.html#d6d6661890be22017e75446a24e41bc2">TagType</a>;
<a name="l00263"></a>00263         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="_master_r_d_8h.html#0cc421aee1dab5540192abf5144d16c2">bcnt</a> = 0x04;<span class="comment">//mifare card use 0x04</span>
<a name="l00264"></a>00264         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="_master_r_d_8h.html#d7f5fc5b86ef30fce39719bb3f455208">Snr</a>[7];
<a name="l00265"></a>00265         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> len;
<a name="l00266"></a>00266                 
<a name="l00267"></a>00267         <span class="keywordflow">if</span>(!<a class="code" href="class_r_f_i_d___c_r500.html#40862a8ca6eeaf91bb5974f17641285a">connected</a>) <span class="comment">// keine Verbindung</span>
<a name="l00268"></a>00268                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00269"></a>00269         
<a name="l00270"></a>00270         status = rf_request(<a class="code" href="class_r_f_i_d___c_r500.html#db93e027f9415df3008e43478a9bdaed">icdev</a>,mode,&amp;TagType);<span class="comment">//search all card</span>
<a name="l00271"></a>00271         <span class="keywordflow">if</span>(status){<span class="comment">//error</span>
<a name="l00272"></a>00272                 rf_light(<a class="code" href="class_r_f_i_d___c_r500.html#db93e027f9415df3008e43478a9bdaed">icdev</a>,<a class="code" href="_r_f_i_d___c_r500_8h.html#99fb83031ce9923c84392b4e92f956b5c9da5c4501ff07f5930282709dec61b3">GREEN_LED</a>);
<a name="l00273"></a>00273                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00274"></a>00274         }
<a name="l00275"></a>00275         status = rf_anticoll(<a class="code" href="class_r_f_i_d___c_r500.html#db93e027f9415df3008e43478a9bdaed">icdev</a>,bcnt,Snr,&amp;len);<span class="comment">//return serial number of card</span>
<a name="l00276"></a>00276         <span class="keywordflow">if</span>(status || len != 4)  <span class="comment">//error</span>
<a name="l00277"></a>00277                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00278"></a>00278         
<a name="l00279"></a>00279                 
<a name="l00280"></a>00280         status = rf_ul_select(<a class="code" href="class_r_f_i_d___c_r500.html#db93e027f9415df3008e43478a9bdaed">icdev</a>,Snr,&amp;len);<span class="comment">//lock ISO14443-3 TYPE_A </span>
<a name="l00281"></a>00281         <span class="keywordflow">if</span>(status) <span class="comment">//error</span>
<a name="l00282"></a>00282                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00283"></a>00283         rf_light(<a class="code" href="class_r_f_i_d___c_r500.html#db93e027f9415df3008e43478a9bdaed">icdev</a>,<a class="code" href="_r_f_i_d___c_r500_8h.html#99fb83031ce9923c84392b4e92f956b57f48418c60e70982c78f0684ac2950fe">NO_LED</a>);
<a name="l00284"></a>00284         rf_light(<a class="code" href="class_r_f_i_d___c_r500.html#db93e027f9415df3008e43478a9bdaed">icdev</a>,<a class="code" href="_r_f_i_d___c_r500_8h.html#99fb83031ce9923c84392b4e92f956b59924710c1e80e5287b87b1d6541c3623">YELLOW_LED</a>);
<a name="l00285"></a>00285         <a class="code" href="class_r_f_i_d___c_r500.html#92b6e6199e3e40cdeddceafe64707af9">oldSerial</a> = <a class="code" href="class_r_f_i_d___c_r500.html#80434957a623b58350ddd0b0eea45133">serial</a>;
<a name="l00286"></a>00286         <a class="code" href="class_r_f_i_d___c_r500.html#80434957a623b58350ddd0b0eea45133">serial</a> = QByteArray::fromRawData((<span class="keyword">const</span> <span class="keywordtype">char</span>*)Snr,len).toHex();
<a name="l00287"></a>00287         <a class="code" href="class_b_e_o___timing.html#ab6e90f89fdd1a266ef14556a97c4212">BEO_Timing::updateMessage</a>(<span class="stringliteral">"RFID-Karte gefunden ("</span> + <a class="code" href="class_r_f_i_d___c_r500.html#80434957a623b58350ddd0b0eea45133">serial</a> + <span class="stringliteral">")"</span>);
<a name="l00288"></a>00288         qDebug() &lt;&lt; <a class="code" href="class_r_f_i_d___c_r500.html#80434957a623b58350ddd0b0eea45133">serial</a>;
<a name="l00289"></a>00289         qDebug() &lt;&lt; <a class="code" href="class_r_f_i_d___c_r500.html#92b6e6199e3e40cdeddceafe64707af9">oldSerial</a>.compare(<a class="code" href="class_r_f_i_d___c_r500.html#80434957a623b58350ddd0b0eea45133">serial</a>);
<a name="l00290"></a>00290         <span class="keywordflow">if</span>(<a class="code" href="class_r_f_i_d___c_r500.html#92b6e6199e3e40cdeddceafe64707af9">oldSerial</a>.compare(<a class="code" href="class_r_f_i_d___c_r500.html#80434957a623b58350ddd0b0eea45133">serial</a>)==0){
<a name="l00291"></a>00291                 <span class="comment">// Gleiche Karte wie zuvor</span>
<a name="l00292"></a>00292                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00293"></a>00293         }
<a name="l00294"></a>00294         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00295"></a>00295 }
<a name="l00296"></a>00296 
<a name="l00300"></a><a class="code" href="class_r_f_i_d___c_r500.html#0ff3f9ea5a0d59d36532bcdd21854755">00300</a> <span class="keywordtype">bool</span> <a class="code" href="class_r_f_i_d___c_r500.html#0ff3f9ea5a0d59d36532bcdd21854755" title="Lesen der gefundenen Karte.">RFID_CR500::readData</a>() {
<a name="l00301"></a>00301         <span class="keywordtype">int</span> state = 1;
<a name="l00302"></a>00302         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="_master_r_d_8h.html#2d96f320e76c39efa636fadfca9301b9">pData</a>[64];
<a name="l00303"></a>00303         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> cLen;
<a name="l00304"></a>00304 
<a name="l00305"></a>00305         <span class="keywordflow">if</span> (!<a class="code" href="class_r_f_i_d___c_r500.html#40862a8ca6eeaf91bb5974f17641285a">connected</a>) <span class="comment">// keine Verbindung</span>
<a name="l00306"></a>00306                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00307"></a>00307         
<a name="l00308"></a>00308         <span class="keywordflow">if</span>(<a class="code" href="class_r_f_i_d___c_r500.html#92b6e6199e3e40cdeddceafe64707af9">oldSerial</a>.compare(<a class="code" href="class_r_f_i_d___c_r500.html#80434957a623b58350ddd0b0eea45133">serial</a>)==0){
<a name="l00309"></a>00309                 <span class="comment">// Gleiche Karte wie zuvor</span>
<a name="l00310"></a>00310                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00311"></a>00311         }
<a name="l00312"></a>00312         <span class="comment">// Lesen der Statusbits</span>
<a name="l00313"></a>00313         state = rf_M1_read(<a class="code" href="class_r_f_i_d___c_r500.html#db93e027f9415df3008e43478a9bdaed">icdev</a>, <a class="code" href="_r_f_i_d___c_r500_8h.html#597463e32a8f9644e3539086cf45aac0" title="Pagenummer des Statusbits in der RFID-Karte.">RFID_ADR_STATUS</a>, pData, &amp;cLen);
<a name="l00314"></a>00314         <span class="keywordflow">if</span> (state || cLen != 16) {
<a name="l00315"></a>00315                 QMessageBox::critical(
<a name="l00316"></a>00316                                 0,
<a name="l00317"></a>00317                                 QObject::tr(<span class="stringliteral">"Lesefehler"</span>),
<a name="l00318"></a>00318                                 QObject::tr(<span class="stringliteral">"Die Daten auf der Karte konnten nicht gelesen werden,\n"</span>
<a name="l00319"></a>00319                                                         <span class="stringliteral">"die Karte ist eventuell defekt!"</span>));
<a name="l00320"></a>00320                 <span class="keywordflow">return</span> <span class="keyword">false</span>; 
<a name="l00321"></a>00321         }
<a name="l00322"></a>00322         <span class="comment">// Statusflags überprüfen</span>
<a name="l00323"></a>00323         <span class="keywordflow">if</span>(pData[0] == (<a class="code" href="_r_f_i_d___c_r500_8h.html#035cb5f2ac9f139c0ab5a178209249fd" title="Gültige Streckennr. aud der Karte.">TAG_STATUS_STRECKENVALID</a> | 
<a name="l00324"></a>00324                                         <a class="code" href="_r_f_i_d___c_r500_8h.html#3c36907efdfc9c64816e09fa0618b8ca" title="Gültige Startzeit auf der Karte.">TAG_STATUS_STARTVALID</a> | 
<a name="l00325"></a>00325                                         <a class="code" href="_r_f_i_d___c_r500_8h.html#a7f8d28b6faa7976ed39b7936a4904e5" title="Gültige Endzeit auf der Karte.">TAG_STATUS_ENDVALID</a> &amp; 
<a name="l00326"></a>00326                                         ~<a class="code" href="_r_f_i_d___c_r500_8h.html#b5ed5ada4835710a7c3c0866937fb9f3" title="Karte ist Manuel gelöscht worden.">TAG_STATUS_MANUALCLEARED</a> &amp; 
<a name="l00327"></a>00327                                         ~<a class="code" href="_r_f_i_d___c_r500_8h.html#c8f9aa4914aec834b758cbf6e16e1cf1" title="Karte ist Persönlich.">TAG_STATUS_REGISTERED</a>)){
<a name="l00328"></a>00328                 <span class="comment">// --&gt; Auswerten</span>
<a name="l00329"></a>00329         }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(pData[0] == (<a class="code" href="_r_f_i_d___c_r500_8h.html#035cb5f2ac9f139c0ab5a178209249fd" title="Gültige Streckennr. aud der Karte.">TAG_STATUS_STRECKENVALID</a> | 
<a name="l00330"></a>00330                                         <a class="code" href="_r_f_i_d___c_r500_8h.html#3c36907efdfc9c64816e09fa0618b8ca" title="Gültige Startzeit auf der Karte.">TAG_STATUS_STARTVALID</a> | 
<a name="l00331"></a>00331                                         <a class="code" href="_r_f_i_d___c_r500_8h.html#a7f8d28b6faa7976ed39b7936a4904e5" title="Gültige Endzeit auf der Karte.">TAG_STATUS_ENDVALID</a> | 
<a name="l00332"></a>00332                                         <a class="code" href="_r_f_i_d___c_r500_8h.html#b5ed5ada4835710a7c3c0866937fb9f3" title="Karte ist Manuel gelöscht worden.">TAG_STATUS_MANUALCLEARED</a> &amp; 
<a name="l00333"></a>00333                                         ~<a class="code" href="_r_f_i_d___c_r500_8h.html#c8f9aa4914aec834b758cbf6e16e1cf1" title="Karte ist Persönlich.">TAG_STATUS_REGISTERED</a>)){
<a name="l00334"></a>00334                 <span class="comment">// --&gt; Zeit manuell gelöscht</span>
<a name="l00335"></a>00335                 QMessageBox::critical(
<a name="l00336"></a>00336                                                 0,
<a name="l00337"></a>00337                                                 QObject::tr(<span class="stringliteral">"Zeit wurde gelöscht"</span>),
<a name="l00338"></a>00338                                                 QObject::tr(<span class="stringliteral">"Der Teilnehmer hat die Zeiten auf der Karte manuell gelöscht. "</span>) +
<a name="l00339"></a>00339                                                 QObject::tr(<span class="stringliteral">"Die Karte kann ohne weitere Massnahmen wieder verwendet werden."</span>));
<a name="l00340"></a>00340                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00341"></a>00341         }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(pData[0] &amp; <a class="code" href="_r_f_i_d___c_r500_8h.html#c8f9aa4914aec834b758cbf6e16e1cf1" title="Karte ist Persönlich.">TAG_STATUS_REGISTERED</a>){
<a name="l00342"></a>00342                 <span class="comment">// --&gt; Persönliche Karte</span>
<a name="l00343"></a>00343                 QSqlQuery query;
<a name="l00344"></a>00344                 query.exec(<span class="stringliteral">"SELECT name, vorname, adresse, PLZ, ort, email, telefon, mobile "</span>
<a name="l00345"></a>00345                                    <span class="stringliteral">"FROM teilnehmer WHERE SNR_RFID='"</span> + <a class="code" href="class_r_f_i_d___c_r500.html#80434957a623b58350ddd0b0eea45133">serial</a> + <span class="stringliteral">"'"</span>);
<a name="l00346"></a>00346                 QString kontakt;
<a name="l00347"></a>00347                 <span class="keywordflow">if</span>(query.next()){
<a name="l00348"></a>00348                         kontakt = <span class="stringliteral">"Der Ihnaber ist: \n"</span> + query.value(0).toString() + <span class="stringliteral">" "</span> + 
<a name="l00349"></a>00349                         query.value(1).toString() + <span class="stringliteral">", "</span> + query.value(2).toString() + 
<a name="l00350"></a>00350                         <span class="stringliteral">", "</span> + query.value(3).toString() + <span class="stringliteral">" "</span> + query.value(4).toString() + 
<a name="l00351"></a>00351                         <span class="stringliteral">", "</span> + query.value(5).toString() + <span class="stringliteral">", "</span> + query.value(6).toString() + 
<a name="l00352"></a>00352                         <span class="stringliteral">", "</span> + query.value(7).toString();
<a name="l00353"></a>00353                 }<span class="keywordflow">else</span>{
<a name="l00354"></a>00354                         kontakt = <span class="stringliteral">"Kein Teilnehmer in der Datenbank. \nRetournieren Sie diese Karte an den Administrator."</span>;
<a name="l00355"></a>00355                 }
<a name="l00356"></a>00356                 
<a name="l00357"></a>00357                 QMessageBox::critical(
<a name="l00358"></a>00358                                 0,
<a name="l00359"></a>00359                                 QObject::tr(<span class="stringliteral">"Persönliche Karte"</span>),
<a name="l00360"></a>00360                                 QObject::tr(<span class="stringliteral">"Diese Karte ist als Persönlich registriert. "</span>) + kontakt);
<a name="l00361"></a>00361                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00362"></a>00362         }<span class="keywordflow">else</span>{
<a name="l00363"></a>00363                 QMessageBox::critical(
<a name="l00364"></a>00364                                 0,
<a name="l00365"></a>00365                                 QObject::tr(<span class="stringliteral">"Lesefehler"</span>),
<a name="l00366"></a>00366                                 QObject::tr(<span class="stringliteral">"Die Daten auf der Karte konnten nicht gelesen werden,\n"</span>
<a name="l00367"></a>00367                                         <span class="stringliteral">"oder sind nicht Gültig! Wahrscheinlich wurde diese Karte bereits ausgewertet."</span>));
<a name="l00368"></a>00368                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00369"></a>00369         }
<a name="l00370"></a>00370         
<a name="l00371"></a>00371         <span class="comment">// Weitere Daten aus der Karte lesen, falls die Statusbits dies zulassen</span>
<a name="l00372"></a>00372         state = rf_M1_read(<a class="code" href="class_r_f_i_d___c_r500.html#db93e027f9415df3008e43478a9bdaed">icdev</a>, <a class="code" href="_r_f_i_d___c_r500_8h.html#5b7e9a26d58b7f2d86e38725570a189e" title="Pagenummer der Endzeit in der RFID-Karte.">RFID_ADR_ENDTIME</a>, pData+16, &amp;cLen);
<a name="l00373"></a>00373         <span class="keywordflow">if</span> (state || cLen != 16) { 
<a name="l00374"></a>00374                 QMessageBox::critical(
<a name="l00375"></a>00375                                 0,
<a name="l00376"></a>00376                                 QObject::tr(<span class="stringliteral">"Lesefehler"</span>),
<a name="l00377"></a>00377                                 QObject::tr(<span class="stringliteral">"Die Daten auf der Karte konnten nicht gelesen werden,\n"</span>
<a name="l00378"></a>00378                                         <span class="stringliteral">"die Karte ist eventuell defekt!"</span>));
<a name="l00379"></a>00379             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00380"></a>00380         } <span class="keywordflow">else</span> {
<a name="l00381"></a>00381                 <span class="comment">// Gelesene Binärdaten in die Strukturen kopieren, um zu interpretieren</span>
<a name="l00382"></a>00382                 memcpy(&amp;<a class="code" href="class_r_f_i_d___c_r500.html#2fa7bc6f3433a1acf060356166d591a6">strecke</a>,pData+4,2);
<a name="l00383"></a>00383                 memcpy(&amp;startdate, pData+8, 7);
<a name="l00384"></a>00384                 memcpy(&amp;<a class="code" href="class_r_f_i_d___c_r500.html#a833f1ef40098bd9f9d07787bfe45271">enddate</a>, pData+16, 7);
<a name="l00385"></a>00385                 memcpy(&amp;<a class="code" href="class_r_f_i_d___c_r500.html#1790d6c17d8367723c96ad74515bd709">racetime</a>, pData+24, 4);
<a name="l00386"></a>00386         }
<a name="l00387"></a>00387         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00388"></a>00388 }
<a name="l00392"></a><a class="code" href="class_r_f_i_d___c_r500.html#2062849e5d875fb74e71c631468e40c1">00392</a> <span class="keywordtype">bool</span> <a class="code" href="class_r_f_i_d___c_r500.html#2062849e5d875fb74e71c631468e40c1" title="Löschen der Flags, um die Karte als ausgewertet kennzuzeichnen.">RFID_CR500::clearValidFlag</a>(){
<a name="l00393"></a>00393         <span class="keywordtype">int</span> state = 1;
<a name="l00394"></a>00394         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="_master_r_d_8h.html#2d96f320e76c39efa636fadfca9301b9">pData</a>[64];
<a name="l00395"></a>00395         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> cLen;
<a name="l00396"></a>00396         
<a name="l00397"></a>00397         <span class="keywordflow">if</span> (!<a class="code" href="class_r_f_i_d___c_r500.html#40862a8ca6eeaf91bb5974f17641285a">connected</a>) <span class="comment">// keine Verbindung</span>
<a name="l00398"></a>00398                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00399"></a>00399         
<a name="l00400"></a>00400         <span class="keywordflow">if</span>(!<a class="code" href="class_r_f_i_d___c_r500.html#7d3f44b888f7da7cea83111f41bb6d95" title="Karte im Feld suchen.">findCard</a>()){<span class="comment">// Keine Karte gefunden</span>
<a name="l00401"></a>00401                 QMessageBox::critical(0,QObject::tr(<span class="stringliteral">"Keine RFID-Karte"</span>),
<a name="l00402"></a>00402                                 QObject::tr(<span class="stringliteral">"Es liegt keine Karte im Feld des Lesers. Legen Sie die Karte mit der Seriennummer \""</span>) + <a class="code" href="class_r_f_i_d___c_r500.html#92b6e6199e3e40cdeddceafe64707af9">oldSerial</a> + <span class="stringliteral">"\" auf!"</span>);
<a name="l00403"></a>00403                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00404"></a>00404         }
<a name="l00405"></a>00405         <span class="keywordflow">if</span>(<a class="code" href="class_r_f_i_d___c_r500.html#92b6e6199e3e40cdeddceafe64707af9">oldSerial</a>.compare(<a class="code" href="class_r_f_i_d___c_r500.html#80434957a623b58350ddd0b0eea45133">serial</a>)!=0){ <span class="comment">// Falsche Karte</span>
<a name="l00406"></a>00406                 QMessageBox::critical(0,QObject::tr(<span class="stringliteral">"Falsche RFID-Karte"</span>),
<a name="l00407"></a>00407                                 QObject::tr(<span class="stringliteral">"Es liegt nicht die Karte mit der Seriennummer \""</span>) + <a class="code" href="class_r_f_i_d___c_r500.html#92b6e6199e3e40cdeddceafe64707af9">oldSerial</a> + <span class="stringliteral">"\" auf!"</span>);
<a name="l00408"></a>00408                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00409"></a>00409         }
<a name="l00410"></a>00410         <span class="comment">// Andere Statusbits lesen      </span>
<a name="l00411"></a>00411         state = rf_M1_read(<a class="code" href="class_r_f_i_d___c_r500.html#db93e027f9415df3008e43478a9bdaed">icdev</a>, <a class="code" href="_r_f_i_d___c_r500_8h.html#597463e32a8f9644e3539086cf45aac0" title="Pagenummer des Statusbits in der RFID-Karte.">RFID_ADR_STATUS</a>, pData, &amp;cLen);
<a name="l00412"></a>00412         <span class="keywordflow">if</span> (state || cLen != 16) {
<a name="l00413"></a>00413                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00414"></a>00414         }
<a name="l00415"></a>00415         <span class="comment">// Gewählte löschen und alle neu schreiben</span>
<a name="l00416"></a>00416         *pData &amp;= ~(<a class="code" href="_r_f_i_d___c_r500_8h.html#035cb5f2ac9f139c0ab5a178209249fd" title="Gültige Streckennr. aud der Karte.">TAG_STATUS_STRECKENVALID</a> | <a class="code" href="_r_f_i_d___c_r500_8h.html#3c36907efdfc9c64816e09fa0618b8ca" title="Gültige Startzeit auf der Karte.">TAG_STATUS_STARTVALID</a> | <a class="code" href="_r_f_i_d___c_r500_8h.html#a7f8d28b6faa7976ed39b7936a4904e5" title="Gültige Endzeit auf der Karte.">TAG_STATUS_ENDVALID</a>); <span class="comment">// erstes Byte löschen (Valid Data Flag)</span>
<a name="l00417"></a>00417         state = rf_ul_write(<a class="code" href="class_r_f_i_d___c_r500.html#db93e027f9415df3008e43478a9bdaed">icdev</a>,<a class="code" href="_r_f_i_d___c_r500_8h.html#597463e32a8f9644e3539086cf45aac0" title="Pagenummer des Statusbits in der RFID-Karte.">RFID_ADR_STATUS</a>,pData);
<a name="l00418"></a>00418         rf_light(<a class="code" href="class_r_f_i_d___c_r500.html#db93e027f9415df3008e43478a9bdaed">icdev</a>,<a class="code" href="_r_f_i_d___c_r500_8h.html#99fb83031ce9923c84392b4e92f956b5c9da5c4501ff07f5930282709dec61b3">GREEN_LED</a>);
<a name="l00419"></a>00419         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00420"></a>00420 }
<a name="l00424"></a><a class="code" href="class_r_f_i_d___c_r500.html#c72b02ffc4c4b42cfdb97fbed3a2eb97">00424</a> <span class="keywordtype">void</span> <a class="code" href="class_r_f_i_d___c_r500.html#c72b02ffc4c4b42cfdb97fbed3a2eb97" title="Stellt die LED des Lesers auf Grün.">RFID_CR500::greenLED</a>(){
<a name="l00425"></a>00425         rf_light(<a class="code" href="class_r_f_i_d___c_r500.html#db93e027f9415df3008e43478a9bdaed">icdev</a>,<a class="code" href="_r_f_i_d___c_r500_8h.html#99fb83031ce9923c84392b4e92f956b5c9da5c4501ff07f5930282709dec61b3">GREEN_LED</a>);
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00431"></a><a class="code" href="class_r_f_i_d___c_r500.html#b349b713f9636e8f3c04ca4295bc3248">00431</a> <span class="keywordtype">bool</span> <a class="code" href="class_r_f_i_d___c_r500.html#b349b713f9636e8f3c04ca4295bc3248" title="Funktion zum Testen der Verbindung zum Leser.">RFID_CR500::isConnected</a>(){
<a name="l00432"></a>00432         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> version[100];
<a name="l00433"></a>00433         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> len;
<a name="l00434"></a>00434         <span class="keywordtype">char</span> error;
<a name="l00435"></a>00435         error = rf_get_model(<a class="code" href="class_r_f_i_d___c_r500.html#db93e027f9415df3008e43478a9bdaed">icdev</a>,version, &amp;len);
<a name="l00436"></a>00436         <span class="keywordflow">if</span>(error)
<a name="l00437"></a>00437                 <a class="code" href="class_r_f_i_d___c_r500.html#40862a8ca6eeaf91bb5974f17641285a">connected</a> = <span class="keyword">false</span>;
<a name="l00438"></a>00438         <span class="keywordflow">else</span>
<a name="l00439"></a>00439                 <a class="code" href="class_r_f_i_d___c_r500.html#40862a8ca6eeaf91bb5974f17641285a">connected</a> = <span class="keyword">true</span>;
<a name="l00440"></a>00440         <span class="keywordflow">return</span> <a class="code" href="class_r_f_i_d___c_r500.html#40862a8ca6eeaf91bb5974f17641285a">connected</a>;
<a name="l00441"></a>00441 }
<a name="l00442"></a>00442 
<a name="l00443"></a>00443 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Jun 30 09:36:03 2008 for BEO-Timing by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
